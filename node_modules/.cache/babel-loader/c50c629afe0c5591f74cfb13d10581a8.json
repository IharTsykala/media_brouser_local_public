{"ast":null,"code":"var __defProp = Object.defineProperty;\nvar __defProps = Object.defineProperties;\nvar __getOwnPropDescs = Object.getOwnPropertyDescriptors;\nvar __getOwnPropSymbols = Object.getOwnPropertySymbols;\nvar __hasOwnProp = Object.prototype.hasOwnProperty;\nvar __propIsEnum = Object.prototype.propertyIsEnumerable;\n\nvar __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, {\n  enumerable: true,\n  configurable: true,\n  writable: true,\n  value\n}) : obj[key] = value;\n\nvar __spreadValues = (a, b) => {\n  for (var prop in b || (b = {})) if (__hasOwnProp.call(b, prop)) __defNormalProp(a, prop, b[prop]);\n\n  if (__getOwnPropSymbols) for (var prop of __getOwnPropSymbols(b)) {\n    if (__propIsEnum.call(b, prop)) __defNormalProp(a, prop, b[prop]);\n  }\n  return a;\n};\n\nvar __spreadProps = (a, b) => __defProps(a, __getOwnPropDescs(b));\n\nvar __objRest = (source, exclude) => {\n  var target = {};\n\n  for (var prop in source) if (__hasOwnProp.call(source, prop) && exclude.indexOf(prop) < 0) target[prop] = source[prop];\n\n  if (source != null && __getOwnPropSymbols) for (var prop of __getOwnPropSymbols(source)) {\n    if (exclude.indexOf(prop) < 0 && __propIsEnum.call(source, prop)) target[prop] = source[prop];\n  }\n  return target;\n};\n\nimport { ChevronDownIcon } from \"@sanity/icons\";\nimport React, { cloneElement, forwardRef, useCallback, useEffect, useMemo, useReducer, useRef, useState } from \"react\";\nimport { EMPTY_ARRAY } from \"../../constants\";\nimport { _hasFocus, _raf, focusFirstDescendant } from \"../../helpers\";\nimport { useForwardedRef, useResponsiveProp } from \"../../hooks\";\nimport { Box, Button, Card, Stack, Text, TextInput } from \"../../primitives\";\nimport { AnimatedSpinnerIcon, ListBox, ResultsPopover, Root } from \"./autocomplete.styles\";\nimport { AutocompleteOption } from \"./autocompleteOption\";\nimport { autocompleteReducer } from \"./autocompleteReducer\";\nimport { EMPTY_RECORD, AUTOCOMPLETE_LISTBOX_IGNORE_KEYS, AUTOCOMPLETE_POPOVER_FALLBACK_PLACEMENTS, AUTOCOMPLETE_POPOVER_MARGINS, AUTOCOMPLETE_POPOVER_PLACEMENT } from \"./constants\";\n\nconst defaultRenderValue = (value, option) => option ? option.value : value;\n\nconst defaultFilterOption = (query, option) => option.value.toLowerCase().indexOf(query.toLowerCase()) > -1;\n\nconst InnerAutocomplete = forwardRef(function InnerAutocomplete2(props, ref) {\n  const _a = props,\n        {\n    border = true,\n    customValidity,\n    disabled,\n    filterOption: filterOptionProp,\n    fontSize = 2,\n    icon,\n    id,\n    listBox = {},\n    loading,\n    onBlur,\n    onChange,\n    onFocus,\n    onQueryChange,\n    onSelect,\n    openButton,\n    options: optionsProp,\n    padding: paddingProp = 3,\n    popover = {},\n    prefix,\n    radius = 3,\n    readOnly,\n    relatedElements,\n    renderOption: renderOptionProp,\n    renderPopover,\n    renderValue = defaultRenderValue,\n    value: valueProp\n  } = _a,\n        restProps = __objRest(_a, [\"border\", \"customValidity\", \"disabled\", \"filterOption\", \"fontSize\", \"icon\", \"id\", \"listBox\", \"loading\", \"onBlur\", \"onChange\", \"onFocus\", \"onQueryChange\", \"onSelect\", \"openButton\", \"options\", \"padding\", \"popover\", \"prefix\", \"radius\", \"readOnly\", \"relatedElements\", \"renderOption\", \"renderPopover\", \"renderValue\", \"value\"]);\n\n  const [state, dispatch] = useReducer(autocompleteReducer, {\n    activeValue: valueProp || null,\n    focused: false,\n    listFocused: false,\n    query: null,\n    value: valueProp || null\n  });\n  const {\n    activeValue,\n    focused,\n    listFocused,\n    query,\n    value\n  } = state;\n  const defaultRenderOption = useCallback(({\n    value: value2\n  }) => /* @__PURE__ */React.createElement(Card, {\n    \"data-as\": \"button\",\n    padding: paddingProp,\n    radius: 2,\n    tone: \"inherit\"\n  }, /* @__PURE__ */React.createElement(Text, {\n    size: fontSize,\n    textOverflow: \"ellipsis\"\n  }, value2)), [fontSize, paddingProp]);\n  const renderOption = typeof renderOptionProp === \"function\" ? renderOptionProp : defaultRenderOption;\n  const filterOption = typeof filterOptionProp === \"function\" ? filterOptionProp : defaultFilterOption;\n  const [rootElement, setRootElement] = useState(null);\n  const [resultsPopoverElement, setResultsPopoverElement] = useState(null);\n  const inputElementRef = useRef(null);\n  const listBoxElementRef = useRef(null);\n  const focusedElementRef = useRef(null);\n  const valueRef = useRef(value);\n  const valuePropRef = useRef(valueProp);\n  const forwardedRef = useForwardedRef(ref);\n  const popoverMouseWithinRef = useRef(false);\n  const listBoxId = `${id}-listbox`;\n  const options = Array.isArray(optionsProp) ? optionsProp : EMPTY_ARRAY;\n  const padding = useResponsiveProp(paddingProp);\n  const currentOption = useMemo(() => value !== null ? options.find(o => o.value === value) : void 0, [options, value]);\n  const filteredOptions = useMemo(() => options.filter(option => query ? filterOption(query, option) : true), [filterOption, options, query]);\n  const filteredOptionsLen = filteredOptions.length;\n  const activeItemId = activeValue ? `${id}-option-${activeValue}` : void 0;\n  const expanded = query !== null && loading || focused && query !== null;\n  const handleRootBlur = useCallback(event => {\n    setTimeout(() => {\n      if (popoverMouseWithinRef.current) {\n        return;\n      }\n\n      const elements = (relatedElements || []).concat(rootElement ? [rootElement] : [], resultsPopoverElement ? [resultsPopoverElement] : []);\n      let focusInside = false;\n\n      if (document.activeElement) {\n        for (const e of elements) {\n          if (e === document.activeElement || e.contains(document.activeElement)) {\n            focusInside = true;\n            break;\n          }\n        }\n      }\n\n      if (focusInside === false) {\n        dispatch({\n          type: \"root/blur\"\n        });\n        popoverMouseWithinRef.current = false;\n        if (onQueryChange) onQueryChange(null);\n        if (onBlur) onBlur(event);\n      }\n    }, 0);\n  }, [onBlur, onQueryChange, relatedElements, resultsPopoverElement, rootElement]);\n  const handleRootFocus = useCallback(event => {\n    const listBoxElement = listBoxElementRef.current;\n    const focusedElement = event.target instanceof HTMLElement ? event.target : null;\n    focusedElementRef.current = focusedElement;\n    const nextListFocused = Boolean(listBoxElement && focusedElement && listBoxElement.contains(focusedElement));\n    dispatch({\n      type: \"root/setListFocused\",\n      listFocused: nextListFocused\n    });\n  }, []);\n  const handleOptionSelect = useCallback(v => {\n    var _a2;\n\n    dispatch({\n      type: \"value/change\",\n      value: v\n    });\n    popoverMouseWithinRef.current = false;\n    if (onSelect) onSelect(v);\n    valueRef.current = v;\n    if (onChange) onChange(v);\n    if (onQueryChange) onQueryChange(null);\n    (_a2 = inputElementRef.current) == null ? void 0 : _a2.focus();\n  }, [onChange, onSelect, onQueryChange]);\n  const handleRootKeyDown = useCallback(event => {\n    var _a2, _b;\n\n    if (event.key === \"ArrowDown\") {\n      event.preventDefault();\n      if (!filteredOptionsLen) return;\n      const activeOption = filteredOptions.find(o => o.value === activeValue);\n      const activeIndex = activeOption ? filteredOptions.indexOf(activeOption) : -1;\n      const nextActiveOption = filteredOptions[(activeIndex + 1) % filteredOptionsLen];\n\n      if (nextActiveOption) {\n        dispatch({\n          type: \"root/setActiveValue\",\n          value: nextActiveOption.value,\n          listFocused: true\n        });\n      }\n\n      return;\n    }\n\n    if (event.key === \"ArrowUp\") {\n      event.preventDefault();\n      if (!filteredOptionsLen) return;\n      const activeOption = filteredOptions.find(o => o.value === activeValue);\n      const activeIndex = activeOption ? filteredOptions.indexOf(activeOption) : -1;\n      const nextActiveOption = filteredOptions[activeIndex === -1 ? filteredOptionsLen - 1 : (filteredOptionsLen + activeIndex - 1) % filteredOptionsLen];\n\n      if (nextActiveOption) {\n        dispatch({\n          type: \"root/setActiveValue\",\n          value: nextActiveOption.value,\n          listFocused: true\n        });\n      }\n\n      return;\n    }\n\n    if (event.key === \"Escape\") {\n      dispatch({\n        type: \"root/escape\"\n      });\n      popoverMouseWithinRef.current = false;\n      if (onQueryChange) onQueryChange(null);\n      (_a2 = inputElementRef.current) == null ? void 0 : _a2.focus();\n      return;\n    }\n\n    const target = event.target;\n    const listEl = listBoxElementRef.current;\n\n    if ((listEl === target || (listEl == null ? void 0 : listEl.contains(target))) && !AUTOCOMPLETE_LISTBOX_IGNORE_KEYS.includes(event.key)) {\n      (_b = inputElementRef.current) == null ? void 0 : _b.focus();\n      return;\n    }\n  }, [activeValue, filteredOptions, filteredOptionsLen, onQueryChange]);\n  const handleInputChange = useCallback(event => {\n    const nextQuery = event.currentTarget.value;\n    dispatch({\n      type: \"input/change\",\n      query: nextQuery\n    });\n    if (onQueryChange) onQueryChange(nextQuery);\n  }, [onQueryChange]);\n  const handleInputFocus = useCallback(event => {\n    if (!focused) {\n      dispatch({\n        type: \"input/focus\"\n      });\n      if (onFocus) onFocus(event);\n    }\n  }, [focused, onFocus]);\n  const handlePopoverMouseEnter = useCallback(() => {\n    popoverMouseWithinRef.current = true;\n  }, []);\n  const handlePopoverMouseLeave = useCallback(() => {\n    popoverMouseWithinRef.current = false;\n  }, []);\n  const handleClearButtonClick = useCallback(() => {\n    var _a2;\n\n    dispatch({\n      type: \"root/clear\"\n    });\n    valueRef.current = \"\";\n    if (onChange) onChange(\"\");\n    if (onQueryChange) onQueryChange(null);\n    (_a2 = inputElementRef.current) == null ? void 0 : _a2.focus();\n  }, [onChange, onQueryChange]);\n  const handleClearButtonFocus = useCallback(() => {\n    dispatch({\n      type: \"input/focus\"\n    });\n  }, []);\n  useEffect(() => {\n    if (valueProp !== valuePropRef.current) {\n      valuePropRef.current = valueProp;\n\n      if (valueProp !== void 0) {\n        dispatch({\n          type: \"value/change\",\n          value: valueProp\n        });\n        valueRef.current = valueProp;\n      }\n\n      return;\n    }\n\n    if (valueProp !== value) {\n      dispatch({\n        type: \"value/change\",\n        value: valueProp || null\n      });\n    }\n  }, [valueProp, value]);\n  useEffect(() => {\n    if (!focused) {\n      if (valueRef.current) {\n        dispatch({\n          type: \"root/setActiveValue\",\n          value: valueRef.current\n        });\n      }\n    }\n  }, [focused]);\n  useEffect(() => {\n    const listElement = listBoxElementRef.current;\n    if (!listElement) return;\n    const activeOption = filteredOptions.find(o => o.value === activeValue);\n\n    if (activeOption) {\n      const activeIndex = filteredOptions.indexOf(activeOption);\n      const activeItemElement = listElement.childNodes[activeIndex];\n\n      if (activeItemElement) {\n        if (_hasFocus(activeItemElement)) {\n          return;\n        }\n\n        focusFirstDescendant(activeItemElement);\n      }\n    }\n  }, [activeValue, filteredOptions]);\n  const setRef = useCallback(el => {\n    inputElementRef.current = el;\n    forwardedRef.current = el;\n  }, [forwardedRef]);\n  const clearButton = useMemo(() => {\n    if (!loading && !disabled && value) {\n      return {\n        \"aria-label\": \"Clear\",\n        onFocus: handleClearButtonFocus\n      };\n    }\n\n    return void 0;\n  }, [disabled, handleClearButtonFocus, loading, value]);\n  const openButtonBoxPadding = useMemo(() => padding.map(v => v - 2), [padding]);\n  const openButtonPadding = useMemo(() => padding.map(v => v - 1), [padding]);\n  const openButtonProps = useMemo(() => typeof openButton === \"object\" ? openButton : EMPTY_RECORD, [openButton]);\n  const handleOpenClick = useCallback(event => {\n    dispatch({\n      type: \"root/open\",\n      query: value ? renderValue(value, currentOption) : \"\"\n    });\n    if (openButtonProps.onClick) openButtonProps.onClick(event);\n\n    _raf(() => {\n      var _a2;\n\n      return (_a2 = inputElementRef.current) == null ? void 0 : _a2.focus();\n    });\n  }, [currentOption, openButtonProps, renderValue, value]);\n  const openButtonNode = useMemo(() => !disabled && !readOnly && openButton ? /* @__PURE__ */React.createElement(Box, {\n    \"aria-hidden\": expanded,\n    padding: openButtonBoxPadding\n  }, /* @__PURE__ */React.createElement(Button, __spreadProps(__spreadValues({\n    \"aria-label\": \"Open\",\n    disabled: expanded,\n    fontSize,\n    icon: ChevronDownIcon,\n    mode: \"bleed\",\n    padding: openButtonPadding\n  }, openButtonProps), {\n    onClick: handleOpenClick\n  }))) : void 0, [disabled, expanded, fontSize, handleOpenClick, openButton, openButtonBoxPadding, openButtonPadding, openButtonProps, readOnly]);\n  const inputValue = useMemo(() => {\n    if (query === null) {\n      if (value !== null) {\n        return renderValue(value, currentOption);\n      }\n\n      return \"\";\n    }\n\n    return query;\n  }, [currentOption, query, renderValue, value]);\n  const input = /* @__PURE__ */React.createElement(TextInput, __spreadProps(__spreadValues({}, restProps), {\n    \"aria-activedescendant\": activeItemId,\n    \"aria-autocomplete\": \"list\",\n    \"aria-expanded\": expanded,\n    \"aria-owns\": listBoxId,\n    autoCapitalize: \"off\",\n    autoComplete: \"off\",\n    autoCorrect: \"off\",\n    border,\n    clearButton,\n    customValidity,\n    disabled,\n    fontSize,\n    icon,\n    iconRight: loading && AnimatedSpinnerIcon,\n    id,\n    inputMode: \"search\",\n    onChange: handleInputChange,\n    onClear: handleClearButtonClick,\n    onFocus: handleInputFocus,\n    padding,\n    prefix,\n    radius,\n    readOnly,\n    ref: setRef,\n    role: \"combobox\",\n    spellCheck: false,\n    suffix: openButtonNode,\n    value: inputValue\n  }));\n  const handleListBoxKeyDown = useCallback(event => {\n    var _a2;\n\n    if (event.key === \"Tab\") {\n      if (listFocused) (_a2 = inputElementRef.current) == null ? void 0 : _a2.focus();\n    }\n  }, [listFocused]);\n  const content = useMemo(() => {\n    if (filteredOptions.length === 0) return null;\n    return /* @__PURE__ */React.createElement(ListBox, __spreadProps(__spreadValues({\n      onKeyDown: handleListBoxKeyDown,\n      padding: 1\n    }, listBox), {\n      tabIndex: -1\n    }), /* @__PURE__ */React.createElement(Stack, {\n      as: \"ul\",\n      \"aria-multiselectable\": false,\n      id: listBoxId,\n      ref: listBoxElementRef,\n      role: \"listbox\",\n      space: 1\n    }, filteredOptions.map(option => {\n      const active = activeValue !== null ? option.value === activeValue : currentOption === option;\n      return /* @__PURE__ */React.createElement(AutocompleteOption, {\n        id: `${id}-option-${option.value}`,\n        key: option.value,\n        onSelect: handleOptionSelect,\n        selected: active,\n        value: option.value\n      }, cloneElement(renderOption(option), {\n        disabled: loading,\n        selected: active,\n        tabIndex: listFocused && active ? 0 : -1\n      }));\n    })));\n  }, [activeValue, currentOption, filteredOptions, handleOptionSelect, handleListBoxKeyDown, id, listBox, listBoxId, listFocused, loading, renderOption]);\n  const results = useMemo(() => {\n    if (renderPopover) {\n      return renderPopover({\n        content,\n        hidden: !expanded,\n        inputElement: inputElementRef.current\n      }, setResultsPopoverElement);\n    }\n\n    if (filteredOptionsLen === 0) {\n      return null;\n    }\n\n    return /* @__PURE__ */React.createElement(ResultsPopover, __spreadValues({\n      __unstable_margins: AUTOCOMPLETE_POPOVER_MARGINS,\n      arrow: false,\n      constrainSize: true,\n      content,\n      fallbackPlacements: AUTOCOMPLETE_POPOVER_FALLBACK_PLACEMENTS,\n      matchReferenceWidth: true,\n      onMouseEnter: handlePopoverMouseEnter,\n      onMouseLeave: handlePopoverMouseLeave,\n      open: expanded,\n      placement: AUTOCOMPLETE_POPOVER_PLACEMENT,\n      portal: true,\n      radius,\n      ref: setResultsPopoverElement,\n      referenceElement: inputElementRef.current\n    }, popover));\n  }, [content, expanded, filteredOptionsLen, handlePopoverMouseEnter, handlePopoverMouseLeave, popover, radius, renderPopover]);\n  return /* @__PURE__ */React.createElement(Root, {\n    \"data-ui\": \"Autocomplete\",\n    onBlur: handleRootBlur,\n    onFocus: handleRootFocus,\n    onKeyDown: handleRootKeyDown,\n    ref: setRootElement\n  }, input, results);\n});\nconst Autocomplete = InnerAutocomplete;\nexport { Autocomplete };","map":{"version":3,"sources":["/home/ihartsykala/projects/playy/media_brouser_local_public/node_modules/@sanity/ui/lib/esm/components/autocomplete/autocomplete.js"],"names":["__defProp","Object","defineProperty","__defProps","defineProperties","__getOwnPropDescs","getOwnPropertyDescriptors","__getOwnPropSymbols","getOwnPropertySymbols","__hasOwnProp","prototype","hasOwnProperty","__propIsEnum","propertyIsEnumerable","__defNormalProp","obj","key","value","enumerable","configurable","writable","__spreadValues","a","b","prop","call","__spreadProps","__objRest","source","exclude","target","indexOf","ChevronDownIcon","React","cloneElement","forwardRef","useCallback","useEffect","useMemo","useReducer","useRef","useState","EMPTY_ARRAY","_hasFocus","_raf","focusFirstDescendant","useForwardedRef","useResponsiveProp","Box","Button","Card","Stack","Text","TextInput","AnimatedSpinnerIcon","ListBox","ResultsPopover","Root","AutocompleteOption","autocompleteReducer","EMPTY_RECORD","AUTOCOMPLETE_LISTBOX_IGNORE_KEYS","AUTOCOMPLETE_POPOVER_FALLBACK_PLACEMENTS","AUTOCOMPLETE_POPOVER_MARGINS","AUTOCOMPLETE_POPOVER_PLACEMENT","defaultRenderValue","option","defaultFilterOption","query","toLowerCase","InnerAutocomplete","InnerAutocomplete2","props","ref","_a","border","customValidity","disabled","filterOption","filterOptionProp","fontSize","icon","id","listBox","loading","onBlur","onChange","onFocus","onQueryChange","onSelect","openButton","options","optionsProp","padding","paddingProp","popover","prefix","radius","readOnly","relatedElements","renderOption","renderOptionProp","renderPopover","renderValue","valueProp","restProps","state","dispatch","activeValue","focused","listFocused","defaultRenderOption","value2","createElement","tone","size","textOverflow","rootElement","setRootElement","resultsPopoverElement","setResultsPopoverElement","inputElementRef","listBoxElementRef","focusedElementRef","valueRef","valuePropRef","forwardedRef","popoverMouseWithinRef","listBoxId","Array","isArray","currentOption","find","o","filteredOptions","filter","filteredOptionsLen","length","activeItemId","expanded","handleRootBlur","event","setTimeout","current","elements","concat","focusInside","document","activeElement","e","contains","type","handleRootFocus","listBoxElement","focusedElement","HTMLElement","nextListFocused","Boolean","handleOptionSelect","v","_a2","focus","handleRootKeyDown","_b","preventDefault","activeOption","activeIndex","nextActiveOption","listEl","includes","handleInputChange","nextQuery","currentTarget","handleInputFocus","handlePopoverMouseEnter","handlePopoverMouseLeave","handleClearButtonClick","handleClearButtonFocus","listElement","activeItemElement","childNodes","setRef","el","clearButton","openButtonBoxPadding","map","openButtonPadding","openButtonProps","handleOpenClick","onClick","openButtonNode","mode","inputValue","input","autoCapitalize","autoComplete","autoCorrect","iconRight","inputMode","onClear","role","spellCheck","suffix","handleListBoxKeyDown","content","onKeyDown","tabIndex","as","space","active","selected","results","hidden","inputElement","__unstable_margins","arrow","constrainSize","fallbackPlacements","matchReferenceWidth","onMouseEnter","onMouseLeave","open","placement","portal","referenceElement","Autocomplete"],"mappings":"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","sourcesContent":["var __defProp = Object.defineProperty;\nvar __defProps = Object.defineProperties;\nvar __getOwnPropDescs = Object.getOwnPropertyDescriptors;\nvar __getOwnPropSymbols = Object.getOwnPropertySymbols;\nvar __hasOwnProp = Object.prototype.hasOwnProperty;\nvar __propIsEnum = Object.prototype.propertyIsEnumerable;\nvar __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;\nvar __spreadValues = (a, b) => {\n  for (var prop in b || (b = {}))\n    if (__hasOwnProp.call(b, prop))\n      __defNormalProp(a, prop, b[prop]);\n  if (__getOwnPropSymbols)\n    for (var prop of __getOwnPropSymbols(b)) {\n      if (__propIsEnum.call(b, prop))\n        __defNormalProp(a, prop, b[prop]);\n    }\n  return a;\n};\nvar __spreadProps = (a, b) => __defProps(a, __getOwnPropDescs(b));\nvar __objRest = (source, exclude) => {\n  var target = {};\n  for (var prop in source)\n    if (__hasOwnProp.call(source, prop) && exclude.indexOf(prop) < 0)\n      target[prop] = source[prop];\n  if (source != null && __getOwnPropSymbols)\n    for (var prop of __getOwnPropSymbols(source)) {\n      if (exclude.indexOf(prop) < 0 && __propIsEnum.call(source, prop))\n        target[prop] = source[prop];\n    }\n  return target;\n};\nimport { ChevronDownIcon } from \"@sanity/icons\";\nimport React, {\n  cloneElement,\n  forwardRef,\n  useCallback,\n  useEffect,\n  useMemo,\n  useReducer,\n  useRef,\n  useState\n} from \"react\";\nimport { EMPTY_ARRAY } from \"../../constants\";\nimport { _hasFocus, _raf, focusFirstDescendant } from \"../../helpers\";\nimport { useForwardedRef, useResponsiveProp } from \"../../hooks\";\nimport { Box, Button, Card, Stack, Text, TextInput } from \"../../primitives\";\nimport { AnimatedSpinnerIcon, ListBox, ResultsPopover, Root } from \"./autocomplete.styles\";\nimport { AutocompleteOption } from \"./autocompleteOption\";\nimport { autocompleteReducer } from \"./autocompleteReducer\";\nimport {\n  EMPTY_RECORD,\n  AUTOCOMPLETE_LISTBOX_IGNORE_KEYS,\n  AUTOCOMPLETE_POPOVER_FALLBACK_PLACEMENTS,\n  AUTOCOMPLETE_POPOVER_MARGINS,\n  AUTOCOMPLETE_POPOVER_PLACEMENT\n} from \"./constants\";\nconst defaultRenderValue = (value, option) => option ? option.value : value;\nconst defaultFilterOption = (query, option) => option.value.toLowerCase().indexOf(query.toLowerCase()) > -1;\nconst InnerAutocomplete = forwardRef(function InnerAutocomplete2(props, ref) {\n  const _a = props, {\n    border = true,\n    customValidity,\n    disabled,\n    filterOption: filterOptionProp,\n    fontSize = 2,\n    icon,\n    id,\n    listBox = {},\n    loading,\n    onBlur,\n    onChange,\n    onFocus,\n    onQueryChange,\n    onSelect,\n    openButton,\n    options: optionsProp,\n    padding: paddingProp = 3,\n    popover = {},\n    prefix,\n    radius = 3,\n    readOnly,\n    relatedElements,\n    renderOption: renderOptionProp,\n    renderPopover,\n    renderValue = defaultRenderValue,\n    value: valueProp\n  } = _a, restProps = __objRest(_a, [\n    \"border\",\n    \"customValidity\",\n    \"disabled\",\n    \"filterOption\",\n    \"fontSize\",\n    \"icon\",\n    \"id\",\n    \"listBox\",\n    \"loading\",\n    \"onBlur\",\n    \"onChange\",\n    \"onFocus\",\n    \"onQueryChange\",\n    \"onSelect\",\n    \"openButton\",\n    \"options\",\n    \"padding\",\n    \"popover\",\n    \"prefix\",\n    \"radius\",\n    \"readOnly\",\n    \"relatedElements\",\n    \"renderOption\",\n    \"renderPopover\",\n    \"renderValue\",\n    \"value\"\n  ]);\n  const [state, dispatch] = useReducer(autocompleteReducer, {\n    activeValue: valueProp || null,\n    focused: false,\n    listFocused: false,\n    query: null,\n    value: valueProp || null\n  });\n  const { activeValue, focused, listFocused, query, value } = state;\n  const defaultRenderOption = useCallback(({ value: value2 }) => /* @__PURE__ */ React.createElement(Card, {\n    \"data-as\": \"button\",\n    padding: paddingProp,\n    radius: 2,\n    tone: \"inherit\"\n  }, /* @__PURE__ */ React.createElement(Text, {\n    size: fontSize,\n    textOverflow: \"ellipsis\"\n  }, value2)), [fontSize, paddingProp]);\n  const renderOption = typeof renderOptionProp === \"function\" ? renderOptionProp : defaultRenderOption;\n  const filterOption = typeof filterOptionProp === \"function\" ? filterOptionProp : defaultFilterOption;\n  const [rootElement, setRootElement] = useState(null);\n  const [resultsPopoverElement, setResultsPopoverElement] = useState(null);\n  const inputElementRef = useRef(null);\n  const listBoxElementRef = useRef(null);\n  const focusedElementRef = useRef(null);\n  const valueRef = useRef(value);\n  const valuePropRef = useRef(valueProp);\n  const forwardedRef = useForwardedRef(ref);\n  const popoverMouseWithinRef = useRef(false);\n  const listBoxId = `${id}-listbox`;\n  const options = Array.isArray(optionsProp) ? optionsProp : EMPTY_ARRAY;\n  const padding = useResponsiveProp(paddingProp);\n  const currentOption = useMemo(() => value !== null ? options.find((o) => o.value === value) : void 0, [options, value]);\n  const filteredOptions = useMemo(() => options.filter((option) => query ? filterOption(query, option) : true), [filterOption, options, query]);\n  const filteredOptionsLen = filteredOptions.length;\n  const activeItemId = activeValue ? `${id}-option-${activeValue}` : void 0;\n  const expanded = query !== null && loading || focused && query !== null;\n  const handleRootBlur = useCallback((event) => {\n    setTimeout(() => {\n      if (popoverMouseWithinRef.current) {\n        return;\n      }\n      const elements = (relatedElements || []).concat(rootElement ? [rootElement] : [], resultsPopoverElement ? [resultsPopoverElement] : []);\n      let focusInside = false;\n      if (document.activeElement) {\n        for (const e of elements) {\n          if (e === document.activeElement || e.contains(document.activeElement)) {\n            focusInside = true;\n            break;\n          }\n        }\n      }\n      if (focusInside === false) {\n        dispatch({ type: \"root/blur\" });\n        popoverMouseWithinRef.current = false;\n        if (onQueryChange)\n          onQueryChange(null);\n        if (onBlur)\n          onBlur(event);\n      }\n    }, 0);\n  }, [onBlur, onQueryChange, relatedElements, resultsPopoverElement, rootElement]);\n  const handleRootFocus = useCallback((event) => {\n    const listBoxElement = listBoxElementRef.current;\n    const focusedElement = event.target instanceof HTMLElement ? event.target : null;\n    focusedElementRef.current = focusedElement;\n    const nextListFocused = Boolean(listBoxElement && focusedElement && listBoxElement.contains(focusedElement));\n    dispatch({ type: \"root/setListFocused\", listFocused: nextListFocused });\n  }, []);\n  const handleOptionSelect = useCallback((v) => {\n    var _a2;\n    dispatch({ type: \"value/change\", value: v });\n    popoverMouseWithinRef.current = false;\n    if (onSelect)\n      onSelect(v);\n    valueRef.current = v;\n    if (onChange)\n      onChange(v);\n    if (onQueryChange)\n      onQueryChange(null);\n    (_a2 = inputElementRef.current) == null ? void 0 : _a2.focus();\n  }, [onChange, onSelect, onQueryChange]);\n  const handleRootKeyDown = useCallback((event) => {\n    var _a2, _b;\n    if (event.key === \"ArrowDown\") {\n      event.preventDefault();\n      if (!filteredOptionsLen)\n        return;\n      const activeOption = filteredOptions.find((o) => o.value === activeValue);\n      const activeIndex = activeOption ? filteredOptions.indexOf(activeOption) : -1;\n      const nextActiveOption = filteredOptions[(activeIndex + 1) % filteredOptionsLen];\n      if (nextActiveOption) {\n        dispatch({ type: \"root/setActiveValue\", value: nextActiveOption.value, listFocused: true });\n      }\n      return;\n    }\n    if (event.key === \"ArrowUp\") {\n      event.preventDefault();\n      if (!filteredOptionsLen)\n        return;\n      const activeOption = filteredOptions.find((o) => o.value === activeValue);\n      const activeIndex = activeOption ? filteredOptions.indexOf(activeOption) : -1;\n      const nextActiveOption = filteredOptions[activeIndex === -1 ? filteredOptionsLen - 1 : (filteredOptionsLen + activeIndex - 1) % filteredOptionsLen];\n      if (nextActiveOption) {\n        dispatch({ type: \"root/setActiveValue\", value: nextActiveOption.value, listFocused: true });\n      }\n      return;\n    }\n    if (event.key === \"Escape\") {\n      dispatch({ type: \"root/escape\" });\n      popoverMouseWithinRef.current = false;\n      if (onQueryChange)\n        onQueryChange(null);\n      (_a2 = inputElementRef.current) == null ? void 0 : _a2.focus();\n      return;\n    }\n    const target = event.target;\n    const listEl = listBoxElementRef.current;\n    if ((listEl === target || (listEl == null ? void 0 : listEl.contains(target))) && !AUTOCOMPLETE_LISTBOX_IGNORE_KEYS.includes(event.key)) {\n      (_b = inputElementRef.current) == null ? void 0 : _b.focus();\n      return;\n    }\n  }, [activeValue, filteredOptions, filteredOptionsLen, onQueryChange]);\n  const handleInputChange = useCallback((event) => {\n    const nextQuery = event.currentTarget.value;\n    dispatch({ type: \"input/change\", query: nextQuery });\n    if (onQueryChange)\n      onQueryChange(nextQuery);\n  }, [onQueryChange]);\n  const handleInputFocus = useCallback((event) => {\n    if (!focused) {\n      dispatch({ type: \"input/focus\" });\n      if (onFocus)\n        onFocus(event);\n    }\n  }, [focused, onFocus]);\n  const handlePopoverMouseEnter = useCallback(() => {\n    popoverMouseWithinRef.current = true;\n  }, []);\n  const handlePopoverMouseLeave = useCallback(() => {\n    popoverMouseWithinRef.current = false;\n  }, []);\n  const handleClearButtonClick = useCallback(() => {\n    var _a2;\n    dispatch({ type: \"root/clear\" });\n    valueRef.current = \"\";\n    if (onChange)\n      onChange(\"\");\n    if (onQueryChange)\n      onQueryChange(null);\n    (_a2 = inputElementRef.current) == null ? void 0 : _a2.focus();\n  }, [onChange, onQueryChange]);\n  const handleClearButtonFocus = useCallback(() => {\n    dispatch({ type: \"input/focus\" });\n  }, []);\n  useEffect(() => {\n    if (valueProp !== valuePropRef.current) {\n      valuePropRef.current = valueProp;\n      if (valueProp !== void 0) {\n        dispatch({ type: \"value/change\", value: valueProp });\n        valueRef.current = valueProp;\n      }\n      return;\n    }\n    if (valueProp !== value) {\n      dispatch({ type: \"value/change\", value: valueProp || null });\n    }\n  }, [valueProp, value]);\n  useEffect(() => {\n    if (!focused) {\n      if (valueRef.current) {\n        dispatch({ type: \"root/setActiveValue\", value: valueRef.current });\n      }\n    }\n  }, [focused]);\n  useEffect(() => {\n    const listElement = listBoxElementRef.current;\n    if (!listElement)\n      return;\n    const activeOption = filteredOptions.find((o) => o.value === activeValue);\n    if (activeOption) {\n      const activeIndex = filteredOptions.indexOf(activeOption);\n      const activeItemElement = listElement.childNodes[activeIndex];\n      if (activeItemElement) {\n        if (_hasFocus(activeItemElement)) {\n          return;\n        }\n        focusFirstDescendant(activeItemElement);\n      }\n    }\n  }, [activeValue, filteredOptions]);\n  const setRef = useCallback((el) => {\n    inputElementRef.current = el;\n    forwardedRef.current = el;\n  }, [forwardedRef]);\n  const clearButton = useMemo(() => {\n    if (!loading && !disabled && value) {\n      return {\n        \"aria-label\": \"Clear\",\n        onFocus: handleClearButtonFocus\n      };\n    }\n    return void 0;\n  }, [disabled, handleClearButtonFocus, loading, value]);\n  const openButtonBoxPadding = useMemo(() => padding.map((v) => v - 2), [padding]);\n  const openButtonPadding = useMemo(() => padding.map((v) => v - 1), [padding]);\n  const openButtonProps = useMemo(() => typeof openButton === \"object\" ? openButton : EMPTY_RECORD, [openButton]);\n  const handleOpenClick = useCallback((event) => {\n    dispatch({\n      type: \"root/open\",\n      query: value ? renderValue(value, currentOption) : \"\"\n    });\n    if (openButtonProps.onClick)\n      openButtonProps.onClick(event);\n    _raf(() => {\n      var _a2;\n      return (_a2 = inputElementRef.current) == null ? void 0 : _a2.focus();\n    });\n  }, [currentOption, openButtonProps, renderValue, value]);\n  const openButtonNode = useMemo(() => !disabled && !readOnly && openButton ? /* @__PURE__ */ React.createElement(Box, {\n    \"aria-hidden\": expanded,\n    padding: openButtonBoxPadding\n  }, /* @__PURE__ */ React.createElement(Button, __spreadProps(__spreadValues({\n    \"aria-label\": \"Open\",\n    disabled: expanded,\n    fontSize,\n    icon: ChevronDownIcon,\n    mode: \"bleed\",\n    padding: openButtonPadding\n  }, openButtonProps), {\n    onClick: handleOpenClick\n  }))) : void 0, [\n    disabled,\n    expanded,\n    fontSize,\n    handleOpenClick,\n    openButton,\n    openButtonBoxPadding,\n    openButtonPadding,\n    openButtonProps,\n    readOnly\n  ]);\n  const inputValue = useMemo(() => {\n    if (query === null) {\n      if (value !== null) {\n        return renderValue(value, currentOption);\n      }\n      return \"\";\n    }\n    return query;\n  }, [currentOption, query, renderValue, value]);\n  const input = /* @__PURE__ */ React.createElement(TextInput, __spreadProps(__spreadValues({}, restProps), {\n    \"aria-activedescendant\": activeItemId,\n    \"aria-autocomplete\": \"list\",\n    \"aria-expanded\": expanded,\n    \"aria-owns\": listBoxId,\n    autoCapitalize: \"off\",\n    autoComplete: \"off\",\n    autoCorrect: \"off\",\n    border,\n    clearButton,\n    customValidity,\n    disabled,\n    fontSize,\n    icon,\n    iconRight: loading && AnimatedSpinnerIcon,\n    id,\n    inputMode: \"search\",\n    onChange: handleInputChange,\n    onClear: handleClearButtonClick,\n    onFocus: handleInputFocus,\n    padding,\n    prefix,\n    radius,\n    readOnly,\n    ref: setRef,\n    role: \"combobox\",\n    spellCheck: false,\n    suffix: openButtonNode,\n    value: inputValue\n  }));\n  const handleListBoxKeyDown = useCallback((event) => {\n    var _a2;\n    if (event.key === \"Tab\") {\n      if (listFocused)\n        (_a2 = inputElementRef.current) == null ? void 0 : _a2.focus();\n    }\n  }, [listFocused]);\n  const content = useMemo(() => {\n    if (filteredOptions.length === 0)\n      return null;\n    return /* @__PURE__ */ React.createElement(ListBox, __spreadProps(__spreadValues({\n      onKeyDown: handleListBoxKeyDown,\n      padding: 1\n    }, listBox), {\n      tabIndex: -1\n    }), /* @__PURE__ */ React.createElement(Stack, {\n      as: \"ul\",\n      \"aria-multiselectable\": false,\n      id: listBoxId,\n      ref: listBoxElementRef,\n      role: \"listbox\",\n      space: 1\n    }, filteredOptions.map((option) => {\n      const active = activeValue !== null ? option.value === activeValue : currentOption === option;\n      return /* @__PURE__ */ React.createElement(AutocompleteOption, {\n        id: `${id}-option-${option.value}`,\n        key: option.value,\n        onSelect: handleOptionSelect,\n        selected: active,\n        value: option.value\n      }, cloneElement(renderOption(option), {\n        disabled: loading,\n        selected: active,\n        tabIndex: listFocused && active ? 0 : -1\n      }));\n    })));\n  }, [\n    activeValue,\n    currentOption,\n    filteredOptions,\n    handleOptionSelect,\n    handleListBoxKeyDown,\n    id,\n    listBox,\n    listBoxId,\n    listFocused,\n    loading,\n    renderOption\n  ]);\n  const results = useMemo(() => {\n    if (renderPopover) {\n      return renderPopover({ content, hidden: !expanded, inputElement: inputElementRef.current }, setResultsPopoverElement);\n    }\n    if (filteredOptionsLen === 0) {\n      return null;\n    }\n    return /* @__PURE__ */ React.createElement(ResultsPopover, __spreadValues({\n      __unstable_margins: AUTOCOMPLETE_POPOVER_MARGINS,\n      arrow: false,\n      constrainSize: true,\n      content,\n      fallbackPlacements: AUTOCOMPLETE_POPOVER_FALLBACK_PLACEMENTS,\n      matchReferenceWidth: true,\n      onMouseEnter: handlePopoverMouseEnter,\n      onMouseLeave: handlePopoverMouseLeave,\n      open: expanded,\n      placement: AUTOCOMPLETE_POPOVER_PLACEMENT,\n      portal: true,\n      radius,\n      ref: setResultsPopoverElement,\n      referenceElement: inputElementRef.current\n    }, popover));\n  }, [\n    content,\n    expanded,\n    filteredOptionsLen,\n    handlePopoverMouseEnter,\n    handlePopoverMouseLeave,\n    popover,\n    radius,\n    renderPopover\n  ]);\n  return /* @__PURE__ */ React.createElement(Root, {\n    \"data-ui\": \"Autocomplete\",\n    onBlur: handleRootBlur,\n    onFocus: handleRootFocus,\n    onKeyDown: handleRootKeyDown,\n    ref: setRootElement\n  }, input, results);\n});\nconst Autocomplete = InnerAutocomplete;\nexport {\n  Autocomplete\n};\n"]},"metadata":{},"sourceType":"module"}